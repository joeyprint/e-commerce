<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/defaultTemplate :: defaultHead (title='Addcredit')"></head>
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script>
        window.facebookSDKPromise = new Promise(function (resolve) {
            window.fbAsyncInit = function() {
                FB.init({
                    appId            : '620190371768470',
                    cookie           : true,
                    xfbml            : true,
                    version          : 'v3.2'
                })
                resolve(FB)
            }
        });

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
</head>
<body>
    <div id="app">
        <div v-if="authStatus === 'checking'">
            Checking login status...
        </div>
        <div v-if="authStatus === 'connected'">
            connected
            <button
                    @click="logout"
            >
            Logout
            </button>
        </div>
        <div v-if="['not_authorized', 'unknown'].includes(authStatus)">
            <button
                    class="button is-link"
                    @click="signIn"
            >Sign in with Facebook
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.17/vue.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.0/js.cookie.min.js"></script>

    <script type="text/javascript">
        const app = new Vue({
            el: '#app',
            name: 'App',
            data: () => ({
                authStatus: 'checking', // checking, connected, notAuthorized
                authResponse: null,
                id: null
            }),
            async created () {
                const FB = await window.facebookSDKPromise
                FB.getLoginStatus(res => {
                    this.onAuthResponseChange(res)
                    this.onStatusChange(res)
                    FB.Event.subscribe(
                        'auth.authResponseChange',
                        this.onAuthResponseChange
                    )
                    FB.Event.subscribe(
                        'auth.statusChange',
                        this.onStatusChange
                    )
                })
            },
            methods: {
                async signIn () {
                    const result = await new Promise(resolve => {
                        FB.login(resolve, { scope: 'email' })
                    })
                    console.log('Login result', result)
                },
                async onAuthResponseChange ({ authResponse }) { // extract authResponse from event
                    if (authResponse) {
                        console.log(authResponse)
                        const form = new FormData()
                        form.append("accessToken", authResponse.accessToken)
                        const data = await axios.post('http://localhost:8081/auth/facebook', form)
                        if (data) {
                            Cookies.set('x-token', data.data.token)
                        }
                        console.log(data)
                        this.id = authResponse.userID
                        console.log('onAuthResponseChange', authResponse && authResponse.userID)
                    }
                },
                onStatusChange ({ status }) {
                    console.log('onStatusChange', status)
                    this.authStatus = status
                },
                logout() {
                    FB.logout()
                }
            }
        })
    </script>
</body>
</html>